<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent v4.3 - Vertical SL/TP Layout</title>

<style>
body{margin:0;padding:20px;font-family:system-ui;background:#0b0d12;color:#e5e7eb}
.tabs{display:flex;justify-content:center;margin-bottom:20px}
.tab{padding:10px 20px;background:#444;margin:0 5px;border-radius:8px;cursor:pointer}
.tab.active{background:#22c55e}
.tab-content{display:none;flex-wrap:wrap;justify-content:center}
.tab-content.active{display:flex}

.box{width:350px;margin:10px;padding:15px;background:#1a1c28;border-radius:15px;text-align:center;box-shadow: 0 10px 25px rgba(0,0,0,0.5)}
h3{margin:5px 0 15px 0; color:#818cf8}

.mini-dash{display:flex; gap:8px; margin-bottom:15px}
.mini-col{flex:1; padding:10px 5px; background:rgba(255,255,255,0.05); border-radius:10px; cursor:pointer; border:1px solid transparent; transition: 0.2s; min-height: 55px}
.mini-col:hover{background:rgba(255,255,255,0.1)}
.mini-col.active{border-color:#818cf8; background:rgba(129,140,248,0.1)}
.mini-col h4{margin:0; font-size:10px; color:#9ca3af; text-transform:uppercase}
.mini-status{font-weight:700; font-size:13px; margin-top:5px}
.mini-div{font-size:14px; margin-top:2px}

.buy{color:#22c55e}.sell{color:#ef4444}.wait{color:#9ca3af}

canvas{width:100%;height:130px;background:#050505;border-radius:8px;margin-top:10px; display:none}
canvas.active{display:block}

.details{font-size:12px;text-align:left;margin-top:8px;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;line-height:1.6; display:none}
.details.active{display:block}
.details span{color:#818cf8;font-weight:600}

button{width:100%;padding:12px;border-radius:8px;border:none;background:#4a4e78;color:#fff;cursor:pointer;font-weight:700; margin-bottom:10px}
</style>
</head>

<body>

<div class="tabs">
    <div class="tab active" data-tab="crypto">Crypto</div>
    <div class="tab" data-tab="fx">FX</div>
    <div class="tab" data-tab="commodities">Commodities</div>
</div>

<div id="crypto" class="tab-content active"></div>
<div id="fx" class="tab-content"></div>
<div id="commodities" class="tab-content"></div>

<script>
const TWELVE_API_KEY="56019b818e414819ae637fc111228e3b";

const instruments={
    crypto:[["Bitcoin","BTC","BTC/USD"],["Ethereum","ETH","ETH/USD"]],
    fx:[["EUR/USD","EURUSD","EUR/USD"],["USD/JPY","USDJPY","USD/JPY"],["EUR/JPY","EURJPY","EUR/JPY"],["GBP/USD","GBPUSD","GBP/USD"]],
    commodities:[
        ["GOLD","XAUUSD","XAU/USD"],
        ["OIL","OIL","WTI"],
        ["GAS","GAS","NATGAS"],
        ["COFFEE","COFFEE","COFFEE"],
        ["CORN","CORN","CORN"]
    ]
};

const marketData = {};

for(const [cat,list] of Object.entries(instruments)){
    const el=document.getElementById(cat);
    list.forEach(([name,id,symbol])=>{
        el.innerHTML+=`
        <div class="box" id="box_${id}">
            <h3>${name}</h3>
            <div class="mini-dash">
                <div class="mini-col" id="col_${id}_5min" onclick="showTF('${id}','5min')"><h4>Scalp</h4><div id="m5_${id}" class="mini-status">--</div><div id="d5_${id}" class="mini-div"></div></div>
                <div class="mini-col" id="col_${id}_15min" onclick="showTF('${id}','15min')"><h4>Day</h4><div id="m15_${id}" class="mini-status">--</div><div id="d15_${id}" class="mini-div"></div></div>
                <div class="mini-col" id="col_${id}_1h" onclick="showTF('${id}','1h')"><h4>Long</h4><div id="h1_${id}" class="mini-status">--</div><div id="dh1_${id}" class="mini-div"></div></div>
            </div>
            <button onclick="runAgentFull('${symbol}','${id}')">ANALIZUJ RYNEK</button>
            <div id="details_${id}" class="details"></div>
            <canvas id="chart_${id}"></canvas>
        </div>`;
    });
}

const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const EMA=(d,p)=>{let k=2/(p+1),e=d[0];for(let i=1;i<d.length;i++)e=d[i]*k+e*(1-k);return e}
const ATR=(h,l,c,p=14)=>{let t=[];for(let i=1;i<h.length;i++)t.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])));return t.slice(-p).reduce((a,b)=>a+b,0)/p}
const smartF=(v)=>v>100?v.toFixed(2):v.toFixed(5);

function getRSIArray(d, p=14) {
    let rsiArr = [];
    for(let j=p; j<=d.length; j++) {
        let g=0, l=0;
        let slice = d.slice(j-p, j);
        for(let i=0; i<slice.length-1; i++){
            let x=slice[i+1]-slice[i]; x>0?g+=x:l-=x;
        }
        rsiArr.push(l===0?100:100-(100/(1+g/l)));
    }
    return rsiArr;
}

function checkDivergence(prices, rsiArr) {
    const lastP = prices.at(-1), prevP = prices.at(-10);
    const lastR = rsiArr.at(-1), prevR = rsiArr.at(-10);
    if(lastP > prevP && lastR < prevR) return " ðŸ‚ zmÄ™czony byk";
    if(lastP < prevP && lastR > prevR) return " ðŸ» zmÄ™czony niedÅºwiedÅº";
    return null;
}

function getSupportResistance(closes){
    const bins={};const precision=closes.at(-1)>100?1:1000;
    closes.slice(-60).forEach(v=>{const k=Math.round(v*precision)/precision;bins[k]=(bins[k]||0)+1});
    const zones=Object.entries(bins).filter(x=>x[1]>=2).map(x=>+x[0]);
    const p=closes.at(-1);
    return{ supports:zones.filter(x=>x<p).sort((a,b)=>b-a).slice(0,2), resistances:zones.filter(x=>x>p).sort((a,b)=>a-b).slice(0,2) }
}

async function runAgentFull(symbol, id) {
    const tfs = ["5min", "15min", "1h"];
    const labels = ["m5", "m15", "h1"];
    const divLabels = ["d5", "d15", "dh1"];
    marketData[id] = {};

    for(let i=0; i<tfs.length; i++) {
        document.getElementById(`${labels[i]}_${id}`).innerHTML = "...";
        try {
            const r=await fetch(`https://api.twelvedata.com/time_series?symbol=${symbol}&interval=${tfs[i]}&outputsize=80&apikey=${TWELVE_API_KEY}`);
            const d=await r.json();
            if(!d.values) { document.getElementById(`${labels[i]}_${id}`).innerHTML="!"; continue; }
            
            const v=d.values.reverse(), c=v.map(x=>+x.close), h=v.map(x=>+x.high), l=v.map(x=>+x.low);
            const rsiArr=getRSIArray(c), rsi=rsiArr.at(-1);
            const price=c.at(-1), ema9=EMA(c,9), ema21=EMA(c,21), atr=ATR(h,l,c);
            const div = checkDivergence(c, rsiArr);
            
            let sig="WAIT", cls="wait";
            if(ema9>ema21 && rsi>55) { sig="BUY"; cls="buy"; }
            if(ema9<ema21 && rsi<45) { sig="SELL"; cls="sell"; }
            
            document.getElementById(`${labels[i]}_${id}`).innerHTML = `<span class="${cls}">${sig}</span>`;
            document.getElementById(`${divLabels[i]}_${id}`).innerHTML = div ? (div.includes("ðŸ‚") ? "ðŸ‚" : "ðŸ»") : "";
            
            marketData[id][tfs[i]] = { c, sig, cls, price, atr, rsi, div, SR: getSupportResistance(c) };
            await sleep(1200); 
        } catch(e) { console.log(e); }
    }
    showTF(id, '15min');
}

function showTF(id, tf) {
    const data = marketData[id] && marketData[id][tf];
    if(!data) return;

    document.querySelectorAll(`#box_${id} .mini-col`).forEach(el => el.classList.remove('active'));
    document.getElementById(`col_${id}_${tf}`).classList.add('active');

    const det = document.getElementById("details_"+id);
    const chart = document.getElementById("chart_"+id);
    
    let sl=0, tp=0;
    if(data.sig==="BUY"){ sl=data.price-data.atr*1.5; tp=data.price+data.atr*3; }
    if(data.sig==="SELL"){ sl=data.price+data.atr*1.5; tp=data.price-data.atr*3; }

    det.innerHTML = `
        <div style="text-align:center; font-weight:bold" class="${data.cls}">${data.sig} (${tf})</div>
        <div style="text-align:center; color:#fbbf24; font-size:12px; margin: 5px 0">${data.div ? data.div : ""}</div>
        Price: <span>${smartF(data.price)}</span><br>
        SL: <span style="color:#ef4444">${sl?smartF(sl):'---'}</span><br>
        TP: <span style="color:#22c55e">${tp?smartF(tp):'---'}</span><br>
        ATR: ${data.atr.toFixed(4)} | RSI: ${data.rsi.toFixed(1)}
    `;
    
    det.classList.add("active");
    chart.classList.add("active");
    drawChart(id, data.c, data.sig, sl, tp, data.SR);
}

function drawChart(id,c,signal,sl,tp,SR){
    const canvas=document.getElementById("chart_"+id);
    const ctx=canvas.getContext("2d");ctx.clearRect(0,0,300,120);
    const all=[...c,...SR.supports,...SR.resistances];
    if(signal!=="WAIT"){all.push(sl,tp)}
    const max=Math.max(...all),min=Math.min(...all),Y=v=>110-(v-min)/(max-min)*90,X_END=220;

    ctx.beginPath();ctx.strokeStyle="#444";ctx.lineWidth=1.5;
    c.forEach((v,i)=>i?ctx.lineTo(i*(X_END/c.length),Y(v)):ctx.moveTo(0,Y(v)));ctx.stroke();

    const drawL=(val,col,lab,dash=[])=>{
        if(!val)return;const y=Y(val);ctx.setLineDash(dash);ctx.strokeStyle=col;
        ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(X_END,y);ctx.stroke();
        ctx.setLineDash([]);ctx.fillStyle=col;ctx.font="9px Arial";ctx.fillText(lab+":"+smartF(val),X_END+5,y+3);
    }
    SR.supports.forEach(s=>drawL(s,"#3b82f6","S",[2,2]));
    SR.resistances.forEach(r=>drawL(r,"#f59e0b","R",[2,2]));
    if(signal!=="WAIT"){drawL(sl,"#ef4444","SL",[4,2]);drawL(tp,"#22c55e","TP",[4,2])}
}

document.querySelectorAll(".tab").forEach(t=>{
    t.onclick=()=>{
        document.querySelectorAll(".tab,.tab-content").forEach(x=>x.classList.remove("active"))
        t.classList.add("active");document.getElementById(t.dataset.tab).classList.add("active")
    }
});
</script>
</body>

</html>
